# Story 1.9: Global Catalog and Tenant Overlays

## Status

Review

## Story

As a system architect,
I want the LEGO parts catalog and reference data to be global (shared), with tenant-specific overlays for per-account metadata,
so that all users rely on a single source of truth while businesses can maintain their own tags/notes/sort locations.

## Acceptance Criteria

1. Globalize catalog/reference tables
   - Remove tenant scoping from: `legoPartCatalog`, `bricklinkColorReference`, `bricklinkCategoryReference`, `bricklinkPartColorAvailability`, `bricklinkElementReference`.
   - All queries and indexes against these tables operate without `businessAccountId`.
2. Introduce tenant overlay table
   - Create `catalogPartOverlay(businessAccountId, partNumber, tags?, notes?, sortGrid?, sortBin?, createdBy, createdAt, updatedAt?)` with indexes `by_business_part` and `by_businessAccount`.
   - Only org-authenticated users of a tenant can CRUD overlays for that tenant.
3. Search and details behavior
   - `searchParts` and `getPartDetails` read from global tables only (no overlay merge at this time).
   - Existing filtering (colors/categories/freshness) continues to work without tenant constraints.
4. Seeding
   - `scripts/catalog/seed-reference-data.ts` no longer requires `--businessAccount` and seeds a single global dataset.
   - Seed mutations accept `{ records, clearExisting? }` only.
5. RBAC & Governance
   - Global catalog write endpoints (seed and admin maintenance) are restricted to system admins.
   - Overlay CRUD restricted to tenant members; no cross-tenant access.
6. Tests & Docs
   - Backend tests updated to reflect global reads (no tenant needed).
   - Overlay CRUD + RBAC unit tests added.
   - Documentation updated per change proposal.

## Tasks / Subtasks

- [x] Task 1: Schema updates

  - [x] Remove `businessAccountId` from global tables: `legoPartCatalog`, `bricklinkColorReference`, `bricklinkCategoryReference`, `bricklinkPartColorAvailability`, `bricklinkElementReference`.
  - [x] Update indexes/search indexes to remove tenant fields (see Dev Notes).
  - [x] Add `catalogPartOverlay` with fields and indexes described above.

- [x] Task 2: Function updates (`convex/functions/catalog.ts`)

  - [x] `searchParts`: remove tenant filter usage; keep existing color/category/freshness logic.
  - [x] `getPartDetails`: query by `partNumber` only; enrich from global reference tables.
  - [x] Helpers (e.g., `loadCatalogFilters`): compute from global references (no tenant arg).
  - [x] Bricklink client calls: remove tenant identity key; use neutral/global identity if needed.
  - [x] (Optional) Add overlay endpoints `upsertOverlay`, `getOverlay` with tenant RBAC; can be a follow-up slice.

- [x] Task 3: Seed mutations & script

  - [x] Mutations `seedBricklinkColors`, `seedBricklinkCategories`, `seedPartColorAvailability`, `seedElementReferences` → remove tenant args and tenant lookups; clear deletes entire table when specified.
  - [x] Update `scripts/catalog/seed-reference-data.ts` to remove `--businessAccount` handling and call new mutation signatures.
  - [x] Keep `--dryRun` and `--batchSize` behavior.

- [x] Task 4: RBAC enforcement

  - [x] Restrict global catalog write endpoints to system admins.
  - [x] Ensure overlay CRUD is tenant-restricted (use `(businessAccountId, partNumber)` guards).

- [x] Task 5: Tests

  - [x] Update backend tests that asserted tenant filters for catalog/reference reads.
  - [x] Add unit tests for overlay CRUD + RBAC.
  - [x] Ensure E2E search/browse still passes and meets SLA (no overlay merge for now).

- [x] Task 6: Documentation
  - [x] Confirm `docs/changes/2025-09-26-catalog-globalization.md` is present.
  - [x] Verify updated sections in `docs/architecture/data-models.md`, `backend-architecture.md`, and `testing-strategy.md`.

## Dev Notes

- Change Proposal: `docs/changes/2025-09-26-catalog-globalization.md`
- Architecture updates:
  - `docs/architecture/data-models.md` → Global catalog + tenant overlays
  - `docs/architecture/backend-architecture.md` → Global reads, overlay separation
  - `docs/architecture/testing-strategy.md` → Testing guidance for global catalog & overlays

### Schema details (exact)

- Globalize by removing `businessAccountId` from:
  - `legoPartCatalog`, `bricklinkColorReference`, `bricklinkCategoryReference`, `bricklinkPartColorAvailability`, `bricklinkElementReference`.
- Indexes:
  - `legoPartCatalog` → keep `by_partNumber`, `by_category`, `by_categoryPathKey`, `by_primaryColor`, `by_sortLocation`, `by_dataFreshness`, `by_lastUpdated`; search `search_parts` filters exclude tenant fields.
  - `bricklinkColorReference` → `by_colorId`; search `search_color_name` filtered by `colorType`.
  - `bricklinkCategoryReference` → `by_categoryId`, `by_parent`, `by_pathKey`; search `search_category_name` filtered by `parentCategoryId`.
  - `bricklinkPartColorAvailability` → `by_part`, `by_color`.
  - `bricklinkElementReference` → `by_element`, `by_part`, `by_color`.
- New table: `catalogPartOverlay`
  - Fields: `businessAccountId`, `partNumber`, `tags?: string[]`, `notes?: string`, `sortGrid?: string`, `sortBin?: string`, `createdBy`, `createdAt`, `updatedAt?`.
  - Indexes: `by_business_part(businessAccountId, partNumber)`, `by_businessAccount(businessAccountId)`.

### Function signatures (post-change)

- Queries
  - `searchParts({ query, categories?, colors?, pageSize?, cursor?, includeMetadata?, sort?, freshness? })`
  - `getPartDetails({ partNumber, fetchFromBricklink? })`
  - `getCatalogFilters({ selectedColors?, selectedCategories? })`
- Mutations (seeding)
  - `seedBricklinkColors({ records, clearExisting? })`
  - `seedBricklinkCategories({ records, clearExisting? })`
  - `seedPartColorAvailability({ records, clearExisting? })`
  - `seedElementReferences({ records, clearExisting? })`
- Overlays (optional now)
  - `upsertOverlay({ partNumber, tags?, notes?, sortGrid?, sortBin? })`
  - `getOverlay({ partNumber })`

## Testing

- Backend unit/integration: assert that catalog/reference reads succeed with no tenant input.
- Overlay unit tests: CRUD, RBAC (only members of `businessAccountId` can modify overlay rows for that tenant).
- E2E search/browse: unchanged; overlays not merged for now.

## Change Log

| Date       | Version | Description                                       | Author |
| ---------- | ------- | ------------------------------------------------- | ------ |
| 2025-09-26 | 1.0     | Initial story draft for global catalog + overlays | PO     |
| 2025-09-26 | 1.1     | Implemented global catalog + tenant overlay stack | Dev    |

## QA Results

### Review Date: 2025-09-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Catalog queries and RBAC paths are now consistently global, and overlay access is properly scoped to tenant members.
- The seeding workflow regressed: the updated script never authenticates as a system admin, so every protected mutation now throws `Authentication required`.

### Refactoring Performed

- None.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✗ (seeding path lacks executable coverage and the manual script is currently broken)
- All ACs Met: ✗ (AC4/AC6 blocked by unusable seeding workflow)

### Requirements Traceability

- AC1 (global catalog/reference tables): Covered by updated schema and catalog function tests (`__tests__/backend/catalog-functions.test.ts`).
- AC2 (tenant overlay table + RBAC): Covered by new overlay CRUD/RBAC tests in the same suite.
- AC3 (search/details read global data): Exercised by `searchParts`/`getPartDetails` tests verifying tenant-free execution.
- AC4 (seeding flow without tenant parameter): Not satisfied—the script cannot authenticate to call the admin-locked mutations.
- AC5 (RBAC & governance): Catalog write paths continue to require system admins; overlay CRUD restricted to tenant members via `requireActiveUser`.
- AC6 (Tests & Docs): Backend tests updated; however the seeding regression prevents exercising documentation instructions end-to-end.

### Test Coverage Evaluation

- Reviewed unit tests in `__tests__/backend/catalog-functions.test.ts` that validate global reads, overlay RBAC, and admin enforcement on catalog mutations.
- Attempted to run `pnpm vitest __tests__/backend/catalog-functions.test.ts`; execution failed because `crypto.getRandomValues` is unavailable in this sandboxed environment, leaving runtime verification pending.
- No automated coverage exists for the TypeScript seeding script; the regression slipped in without a guard.

### NFR Assessment

- Security: CONCERNS — global catalog writes are restricted, but the unauthenticated seeding script provides no path to satisfy RBAC.
- Performance: PASS — search pagination remains filtered via indices; no new hot paths detected.
- Reliability: CONCERNS — broken seeding means operators cannot refresh reference data, risking stale catalog content.
- Maintainability: PASS — code organization is clear; tests capture overlay behaviors, though script coverage should be added.

### Testability

- Application code remains testable through Convex test context helpers.
- Operational seeding path is currently untestable end-to-end due to missing authentication wiring.

### Technical Debt

- Introduce an authenticated seeding client utility and regression test to prevent future RBAC breaks.

### Improvements Checklist

- [ ] Restore admin authentication inside `scripts/catalog/seed-reference-data.ts` (e.g., use a Convex server client with `setAdminAuth` or service token headers).
- [ ] Add an automated smoke test that exercises the seeding script (or seed mutations) without tenant context.
- [ ] Document the required admin setup for operators after the global catalog change.

### Security Review

- Overlay queries continue to scope by tenant, preventing cross-tenant access.
- Seeding script fails authentication outright; once fixed it should continue to enforce system-admin RBAC.

### Performance Considerations

- No new performance bottlenecks identified; global search still leverages existing indexes.

### Files Modified During Review

- None.

### Gate Status

Gate: FAIL → docs/qa/gates/1.9-global-catalog-tenant-overlays.yml
Risk profile: docs/qa/assessments/1.9-risk-20250926.md
NFR assessment: docs/qa/assessments/1.9-nfr-20250926.md

### Recommended Status

[✗ Changes Required - See unchecked items above]
