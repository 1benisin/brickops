# Story 1.9: Global Catalog and Tenant Overlays

## Status

Draft

## Story

As a system architect,
I want the LEGO parts catalog and reference data to be global (shared), with tenant-specific overlays for per-account metadata,
so that all users rely on a single source of truth while businesses can maintain their own tags/notes/sort locations.

## Acceptance Criteria

1. Globalize catalog/reference tables
   - Remove tenant scoping from: `legoPartCatalog`, `bricklinkColorReference`, `bricklinkCategoryReference`, `bricklinkPartColorAvailability`, `bricklinkElementReference`.
   - All queries and indexes against these tables operate without `businessAccountId`.
2. Introduce tenant overlay table
   - Create `catalogPartOverlay(businessAccountId, partNumber, tags?, notes?, sortGrid?, sortBin?, createdBy, createdAt, updatedAt?)` with indexes `by_business_part` and `by_businessAccount`.
   - Only org-authenticated users of a tenant can CRUD overlays for that tenant.
3. Search and details behavior
   - `searchParts` and `getPartDetails` read from global tables only (no overlay merge at this time).
   - Existing filtering (colors/categories/freshness) continues to work without tenant constraints.
4. Seeding
   - `scripts/catalog/seed-reference-data.ts` no longer requires `--businessAccount` and seeds a single global dataset.
   - Seed mutations accept `{ records, clearExisting? }` only.
5. RBAC & Governance
   - Global catalog write endpoints (seed and admin maintenance) are restricted to system admins.
   - Overlay CRUD restricted to tenant members; no cross-tenant access.
6. Tests & Docs
   - Backend tests updated to reflect global reads (no tenant needed).
   - Overlay CRUD + RBAC unit tests added.
   - Documentation updated per change proposal.

## Tasks / Subtasks

- [ ] Task 1: Schema updates

  - [ ] Remove `businessAccountId` from global tables: `legoPartCatalog`, `bricklinkColorReference`, `bricklinkCategoryReference`, `bricklinkPartColorAvailability`, `bricklinkElementReference`.
  - [ ] Update indexes/search indexes to remove tenant fields (see Dev Notes).
  - [ ] Add `catalogPartOverlay` with fields and indexes described above.

- [ ] Task 2: Function updates (`convex/functions/catalog.ts`)

  - [ ] `searchParts`: remove tenant filter usage; keep existing color/category/freshness logic.
  - [ ] `getPartDetails`: query by `partNumber` only; enrich from global reference tables.
  - [ ] Helpers (e.g., `loadCatalogFilters`): compute from global references (no tenant arg).
  - [ ] Bricklink client calls: remove tenant identity key; use neutral/global identity if needed.
  - [ ] (Optional) Add overlay endpoints `upsertOverlay`, `getOverlay` with tenant RBAC; can be a follow-up slice.

- [ ] Task 3: Seed mutations & script

  - [ ] Mutations `seedBricklinkColors`, `seedBricklinkCategories`, `seedPartColorAvailability`, `seedElementReferences` → remove tenant args and tenant lookups; clear deletes entire table when specified.
  - [ ] Update `scripts/catalog/seed-reference-data.ts` to remove `--businessAccount` handling and call new mutation signatures.
  - [ ] Keep `--dryRun` and `--batchSize` behavior.

- [ ] Task 4: RBAC enforcement

  - [ ] Restrict global catalog write endpoints to system admins.
  - [ ] Ensure overlay CRUD is tenant-restricted (use `(businessAccountId, partNumber)` guards).

- [ ] Task 5: Tests

  - [ ] Update backend tests that asserted tenant filters for catalog/reference reads.
  - [ ] Add unit tests for overlay CRUD + RBAC.
  - [ ] Ensure E2E search/browse still passes and meets SLA (no overlay merge for now).

- [ ] Task 6: Documentation
  - [ ] Confirm `docs/changes/2025-09-26-catalog-globalization.md` is present.
  - [ ] Verify updated sections in `docs/architecture/data-models.md`, `backend-architecture.md`, and `testing-strategy.md`.

## Dev Notes

- Change Proposal: `docs/changes/2025-09-26-catalog-globalization.md`
- Architecture updates:
  - `docs/architecture/data-models.md` → Global catalog + tenant overlays
  - `docs/architecture/backend-architecture.md` → Global reads, overlay separation
  - `docs/architecture/testing-strategy.md` → Testing guidance for global catalog & overlays

### Schema details (exact)

- Globalize by removing `businessAccountId` from:
  - `legoPartCatalog`, `bricklinkColorReference`, `bricklinkCategoryReference`, `bricklinkPartColorAvailability`, `bricklinkElementReference`.
- Indexes:
  - `legoPartCatalog` → keep `by_partNumber`, `by_category`, `by_categoryPathKey`, `by_primaryColor`, `by_sortLocation`, `by_dataFreshness`, `by_lastUpdated`; search `search_parts` filters exclude tenant fields.
  - `bricklinkColorReference` → `by_colorId`; search `search_color_name` filtered by `colorType`.
  - `bricklinkCategoryReference` → `by_categoryId`, `by_parent`, `by_pathKey`; search `search_category_name` filtered by `parentCategoryId`.
  - `bricklinkPartColorAvailability` → `by_part`, `by_color`.
  - `bricklinkElementReference` → `by_element`, `by_part`, `by_color`.
- New table: `catalogPartOverlay`
  - Fields: `businessAccountId`, `partNumber`, `tags?: string[]`, `notes?: string`, `sortGrid?: string`, `sortBin?: string`, `createdBy`, `createdAt`, `updatedAt?`.
  - Indexes: `by_business_part(businessAccountId, partNumber)`, `by_businessAccount(businessAccountId)`.

### Function signatures (post-change)

- Queries
  - `searchParts({ query, categories?, colors?, pageSize?, cursor?, includeMetadata?, sort?, freshness? })`
  - `getPartDetails({ partNumber, fetchFromBricklink? })`
  - `getCatalogFilters({ selectedColors?, selectedCategories? })`
- Mutations (seeding)
  - `seedBricklinkColors({ records, clearExisting? })`
  - `seedBricklinkCategories({ records, clearExisting? })`
  - `seedPartColorAvailability({ records, clearExisting? })`
  - `seedElementReferences({ records, clearExisting? })`
- Overlays (optional now)
  - `upsertOverlay({ partNumber, tags?, notes?, sortGrid?, sortBin? })`
  - `getOverlay({ partNumber })`

## Testing

- Backend unit/integration: assert that catalog/reference reads succeed with no tenant input.
- Overlay unit tests: CRUD, RBAC (only members of `businessAccountId` can modify overlay rows for that tenant).
- E2E search/browse: unchanged; overlays not merged for now.

## Change Log

| Date       | Version | Description                                       | Author |
| ---------- | ------- | ------------------------------------------------- | ------ |
| 2025-09-26 | 1.0     | Initial story draft for global catalog + overlays | PO     |
