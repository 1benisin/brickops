# Story 2.2: Catalog Search and Browse

## Status

Draft

## Story

**As a** user,
**I want** to search and browse the Lego parts catalog,
**so that** I can find specific parts and access detailed information.

## Acceptance Criteria

1. **2.2.1:** User can search parts by part number, description, or keywords
2. **2.2.2:** Search results display part images, numbers, and basic information
3. **2.2.3:** User can filter results by color, category, or other attributes
4. **2.2.4:** System provides pagination for large result sets
5. **2.2.5:** Search results load within 2 seconds for common queries
6. **2.2.6:** User can view detailed part information including market pricing
7. **2.2.7:** System handles search errors and provides helpful feedback

## Tasks / Subtasks

- [ ] Task 1: Catalog search UI and interaction flows (AC: 2.2.1, 2.2.2, 2.2.3, 2.2.4, 2.2.7)

  - [ ] Build the authenticated catalog page with search input, responsive layout, and results grid backed by `useQuery(api.catalog.searchParts)` to surface catalog data in real time. [Source: docs/architecture/frontend-architecture.md#routing-architecture; docs/architecture/frontend-architecture.md#state-management-architecture]
  - [ ] Add filter controls for color, category, and attributes using a Zustand search store so selections persist across pagination and sessions. [Source: docs/architecture/frontend-architecture.md#state-management-architecture]
  - [ ] Implement pagination and page-size controls with accessible shadcn/ui primitives (e.g., Command, Data Table, Pagination) while maintaining mobile-first responsiveness. [Source: docs/architecture/frontend-architecture.md#shadcnui-component-installation; docs/architecture/frontend-architecture.md#design-tokens]
  - [ ] Render each result with part number, name, primary image, category tag, and data source indicators using catalog model fields. [Source: docs/architecture/data-models.md#legopartcatalog; docs/external-documentation/apis/bricklink.md#get-item]
  - [ ] Provide loading, empty, and error states with actionable copy and retry options inline with the error handling strategy. [Source: docs/architecture/error-handling-strategy.md]

- [ ] Task 2: Catalog backend search filters and performance optimization (AC: 2.2.1, 2.2.2, 2.2.3, 2.2.5, 2.2.7)

  - [ ] Extend `convex/functions/catalog.ts` searchParts query to accept color/category filters and pagination cursors while enforcing tenant isolation and search index usage. [Source: docs/architecture/backend-architecture.md#service-architecture-serverless; docs/stories/1.5.basic-catalog-management-system.story.md#dev-notes]
  - [ ] Hydrate filter metadata by exposing convex helpers for Bricklink colors and categories, caching lookups to honor API quotas. [Source: docs/external-documentation/apis/bricklink.md#get-color-list; docs/external-documentation/apis/bricklink.md#get-category-list; docs/architecture/api-specification.md#bricklink-oauth-10a-credentials]
  - [ ] Record search latency metrics and ensure local cache hits satisfy the <=2s requirement for common queries. [Source: docs/architecture/monitoring-and-observability.md#key-metrics; docs/prd/epic-2-part-identification-catalog-integration.md#story-22-catalog-search-and-browse]
  - [ ] Validate inputs and guard Bricklink fallback calls with rate limiting and exponential backoff, surfacing structured errors to the UI. [Source: docs/architecture/security-and-performance.md#security-requirements; docs/architecture/security-and-performance.md#performance-optimization; docs/architecture/error-handling-strategy.md]

- [ ] Task 3: Part detail experience and market pricing (AC: 2.2.2, 2.2.6, 2.2.7)

  - [ ] Present a detail drawer/modal from search results that surfaces extended metadata, imagery, and availability context using shadcn/ui patterns. [Source: docs/architecture/frontend-architecture.md#component-architecture; docs/architecture/frontend-architecture.md#shadcnui-component-installation]
  - [ ] Leverage CatalogService `getPartDetails` plus Bricklink price guide endpoints to display market pricing, color variations, and data freshness indicators. [Source: docs/architecture/components.md#catalogservice; docs/external-documentation/apis/bricklink.md#get-item; docs/external-documentation/apis/bricklink.md#get-item-price]
  - [ ] Handle Bricklink fetch failures by falling back to cached details and communicating status to the user. [Source: docs/architecture/security-and-performance.md#performance-optimization; docs/architecture/error-handling-strategy.md]

- [ ] Task 4: Comprehensive validation and testing (AC: 2.2.1, 2.2.3, 2.2.4, 2.2.5, 2.2.6, 2.2.7)

  - [ ] Add frontend tests covering search submission, filter interactions, pagination, detail drawer, and error boundaries with required data-testid attributes. [Source: docs/architecture/testing-strategy.md#frontend-tests; docs/architecture/testing-strategy.md#test-id-guidelines]
  - [ ] Extend backend catalog function tests for new filters, pagination, and Bricklink fallback behaviors, including rate-limit and performance assertions. [Source: docs/architecture/testing-strategy.md#backend-tests]
  - [ ] Create or update E2E scenarios to exercise search → filter → pagination → detail view workflows with mocked Convex and Bricklink responses. [Source: docs/architecture/testing-strategy.md#e2e-tests]
  - [ ] Capture performance evidence (unit or integration measurement) showing typical queries complete within the required 2-second SLA. [Source: docs/prd/epic-2-part-identification-catalog-integration.md#story-22-catalog-search-and-browse; docs/architecture/monitoring-and-observability.md#key-metrics]

## Dev Notes

### Previous Story Insights

- Part identification now validates Bricklink part numbers via CatalogService, so search flows must surface consistent catalog metadata for identification confirmations. [Source: docs/architecture/core-workflows.md#part-identification-and-inventory-addition; docs/stories/2.1.camera-integration-and-part-identification.story.md#dev-notes]
- Catalog foundations already enforce tenant isolation, caching tiers, and Bricklink rate budgeting that this story must extend rather than replace. [Source: docs/stories/1.5.basic-catalog-management-system.story.md#dev-notes]

### Data Models

- `LegoPartCatalog` stores partNumber, name, category, imageUrl, bricklinkPartId, dataSource, and dataFreshness, forming the primary dataset for search results. [Source: docs/architecture/data-models.md#legopartcatalog]
- Business accounts define tenant boundaries; all catalog queries must filter by businessAccountId to preserve isolation. [Source: docs/architecture/data-models.md#businessaccount]

### API Specifications

- CatalogService exposes `searchParts`, `getPartDetails`, `refreshPartData`, `batchImportParts`, and `validateDataFreshness`, which should remain the integration surface for UI and automation. [Source: docs/architecture/components.md#catalogservice]
- Bricklink integrations require OAuth 1.0a credentials and must respect the 5,000 calls/day quota with budgeting/monitoring. [Source: docs/architecture/api-specification.md#bricklink-oauth-10a-credentials]
- Use Bricklink catalog endpoints for item metadata and imagery as needed (`GET /items/{type}/{no}`) and price guides for market pricing (`GET /items/{type}/{no}/price`). [Source: docs/external-documentation/apis/bricklink.md#get-item; docs/external-documentation/apis/bricklink.md#get-item-price]
- Fetch color and category taxonomies from `/colors` and `/categories` endpoints to populate filter controls. [Source: docs/external-documentation/apis/bricklink.md#get-color-list; docs/external-documentation/apis/bricklink.md#get-category-list]

### Component Specifications

- The authenticated catalog route lives under `app/(authenticated)/catalog` and should use server-aware layouts that align with other dashboard pages. [Source: docs/architecture/frontend-architecture.md#routing-architecture]
- Server state for the catalog is accessed with `useQuery(api.catalog.searchParts)`, while persistent filter state should leverage `useSearchStore`. [Source: docs/architecture/frontend-architecture.md#state-management-architecture]
- Frontend service wrappers in `src/lib/services` consolidate Convex calls and error handling; mirror the inventory service pattern for catalog utilities. [Source: docs/architecture/frontend-architecture.md#frontend-services-layer]
- UI should rely on shadcn/ui components installed via the CLI and adhere to design tokens for typography, spacing, and responsiveness. [Source: docs/architecture/frontend-architecture.md#shadcnui-component-installation; docs/architecture/frontend-architecture.md#design-tokens]

### File Locations

- Backend catalog logic continues in `convex/functions/catalog.ts`, with any shared helpers residing alongside existing external clients. [Source: docs/architecture/backend-architecture.md#service-architecture-serverless]
- Frontend implementations should augment `src/app/(authenticated)/catalog/page.tsx` and related catalog components under `src/components/`. [Source: docs/architecture/frontend-architecture.md#routing-architecture; docs/architecture/source-tree.md]
- Client-side service helpers and utilities belong in `src/lib/services/catalog-service.ts` following existing patterns. [Source: docs/architecture/frontend-architecture.md#frontend-services-layer]
- Tests live under `__tests__/frontend/app`, `__tests__/backend`, and `e2e/` per the testing strategy structure. [Source: docs/architecture/testing-strategy.md#frontend-tests; docs/architecture/testing-strategy.md#backend-tests; docs/architecture/testing-strategy.md#e2e-tests]

### Technical Constraints

- Validate every Convex request with authentication, tenant isolation, and Zod-style input guards to meet security requirements. [Source: docs/architecture/backend-architecture.md#authentication-and-authorization; docs/architecture/security-and-performance.md#security-requirements]
- Maintain caching-first lookups with Bricklink fallback only when local data is stale, targeting sub-2-second responses for common queries. [Source: docs/stories/1.5.basic-catalog-management-system.story.md#qa-results; docs/architecture/security-and-performance.md#performance-optimization]
- Record Convex metrics for search latency, fallback usage, and Bricklink quota consumption to aid observability. [Source: docs/architecture/monitoring-and-observability.md#key-metrics]
- Enforce API quota budgets and exponential backoff when interacting with Bricklink to avoid throttling. [Source: docs/architecture/api-specification.md#bricklink-oauth-10a-credentials; docs/architecture/security-and-performance.md#security-requirements]
- Provide structured error objects so the UI can surface actionable feedback during search failures. [Source: docs/architecture/error-handling-strategy.md]
- This story must satisfy the 2-second SLA for search results defined in the PRD. [Source: docs/prd/epic-2-part-identification-catalog-integration.md#story-22-catalog-search-and-browse]

### Testing

- Follow the testing strategy pyramid: unit coverage for UI state and Convex catalog functions, integration coverage for Bricklink fallbacks, and E2E smoke for the full search-to-detail journey. [Source: docs/architecture/testing-strategy.md#testing-pyramid; docs/architecture/testing-strategy.md#frontend-tests; docs/architecture/testing-strategy.md#backend-tests; docs/architecture/testing-strategy.md#e2e-tests]
- Apply required data-testid conventions to interactive catalog elements and ensure async UI assertions use RTL best practices. [Source: docs/architecture/testing-strategy.md#test-id-guidelines]

## Project Structure Notes

- Catalog work continues within the established authenticated route and Convex catalog domain, matching the documented project layout; no structural deviations required. [Source: docs/architecture/frontend-architecture.md#routing-architecture; docs/architecture/source-tree.md]

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |

## Dev Agent Record

### Agent Model Used

- _TBD_

### Debug Log References

- _TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results

- _TBD_
