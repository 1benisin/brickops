# Story 2.1: Camera Integration and Part Identification

## Status

Done

## Story

**As a** user,
**I want** to identify Lego parts using my mobile camera or webcam,
**so that** I can quickly add parts to my inventory without manual lookup.

## Acceptance Criteria

1. **2.1.1:** User can access camera interface on both mobile and desktop browsers
2. **2.1.2:** Camera captures clear images suitable for part identification
3. **2.1.3:** System integrates with Brickognize API for part recognition
4. **2.1.4:** System displays identification results with confidence scores
5. **2.1.5:** User can retake photos if identification confidence is low
6. **2.1.6:** System handles camera permissions and errors gracefully
7. **2.1.7:** Identification process completes within 5 seconds for common parts

## Tasks / Subtasks

- [x] Task 1: Camera UI and routing (AC: 2.1.1, 2.1.2, 2.1.6)

  - [x] Add route `app/identify/page.tsx` with client-side camera capture interface following mobile-first patterns. [Source: architecture/frontend-architecture.md#routing-architecture; architecture/security-and-performance.md#theme-and-responsive-design]
  - [x] Implement camera permissions flow and error states with clear user feedback. [Source: architecture/frontend-architecture.md#protected-route-pattern; architecture/error-handling-strategy.md]
  - [x] Provide retake flow and ensure images meet minimum quality (resolution/aspect). [Source: architecture/frontend-architecture.md#component-architecture]

- [x] Task 2: File handling and upload to Convex File Storage (AC: 2.1.2)

  - [x] Capture image blob and upload to Convex File Storage; obtain file URL securely. [Source: architecture/core-workflows.md#part-identification-and-inventory-addition]
  - [x] Enforce size/type validation before upload; show progress and errors. [Source: architecture/security-and-performance.md#security-requirements]

- [x] Task 3: Part identification integration (AC: 2.1.3, 2.1.4, 2.1.7)

  - [x] Create `PartIdentificationService` client method to call Convex function which invokes Brickognize `/identify`. [Source: architecture/components.md#partidentificationservice; architecture/api-specification.md#external-provider-credentials]
  - [x] Display results with confidence scores and latency; surface low-confidence messaging with retry guidance. [Source: architecture/core-workflows.md#part-identification-and-inventory-addition]

- [x] Task 4: UX flows and retries (AC: 2.1.5, 2.1.6)

  - [x] Add "Retake" and "Try again" actions; preserve previous image for comparison. [Source: architecture/frontend-architecture.md#state-management-architecture]
  - [x] Handle permission denial, camera unavailable, and offline cases gracefully. [Source: architecture/error-handling-strategy.md]

- [x] Task 5: Testing (unit/integration/E2E) aligned to Testing Strategy (AC: All)

  - [x] Frontend unit tests for camera component states, permission handling, and result rendering. [Source: architecture/testing-strategy.md#frontend-tests]
  - [x] Backend unit/integration tests for identification Convex function including rate limiting and error paths. [Source: architecture/testing-strategy.md#backend-tests; architecture/security-and-performance.md#security-requirements]
  - [x] E2E test for identify flow: capture → results → retake → add to inventory (mock APIs). [Source: architecture/testing-strategy.md#e2e-testing-best-practices]

## Dev Notes

### Architecture & Components

- Use route `app/identify/` for the camera workflow and keep UI mobile-first. [Source: architecture/frontend-architecture.md#routing-architecture; architecture/security-and-performance.md#theme-and-responsive-design]
- Implement UI using shadcn/ui primitives (Dialog, Button, Input, Progress, Toast). Install via CLI only. [Source: architecture/frontend-architecture.md#shadcnui-component-installation]
- State management: local React state for capture UI; optional `useCameraStore` (Zustand) if cross-component coordination is needed. [Source: architecture/frontend-architecture.md#state-management-architecture]

### Services & Backend

- Create Convex function `identify.identifyPartFromImage` that accepts a file reference or bytes, validates auth and tenant, applies rate limiting (e.g., 100/hour per user), and calls Brickognize. [Source: architecture/components.md#partidentificationservice; architecture/security-and-performance.md#security-requirements]
- Store temporary images in Convex File Storage; do not persist beyond identification unless user confirms add-to-inventory. [Source: architecture/core-workflows.md#part-identification-and-inventory-addition]
- Validate provider credentials via Convex env (no API key required for Brickognize). Never expose secrets to client. [Source: architecture/api-specification.md#brickognize-api-key]

### Performance & UX

- Aim for ≤5s identification for common parts; show loading skeletons and progress. [Source: prd/epic-2-part-identification-catalog-integration.md#story-21-camera-integration-and-part-identification]
- Optimize image size before upload (client-side compression) to balance quality/performance. [Source: architecture/security-and-performance.md#performance-optimization]
- Provide accessibility labels and keyboard navigation; maintain responsive layout. [Source: architecture/frontend-architecture.md#design-tokens]

### Security

- Validate inputs with Zod at Convex boundary; enforce tenant isolation using `businessAccountId`. [Source: architecture/security-and-performance.md#security-requirements]
- Apply per-user rate limiting for identification endpoint; monitor provider quotas. [Source: architecture/security-and-performance.md#security-requirements]

### File Locations

- Frontend: `src/app/(authenticated)/identify/page.tsx`, `src/components/identify/*`, `src/lib/services/part-identification-service.ts`. [Source: architecture/unified-project-structure.md]
- Backend: `convex/functions/identify.ts`, `convex/schema.ts` updates as needed, `convex/http.ts` if using HTTP actions. [Source: architecture/source-tree.md]

### Testing

- Follow Testing Strategy patterns for async UI (`act`, `waitFor`), comprehensive API mocking, and role-based auth mocking where applicable. [Source: architecture/testing-strategy.md]
- Ensure E2E mocks camera access and Convex endpoints consistently. [Source: architecture/testing-strategy.md#e2e-testing-best-practices]
- Validation will include unit, integration, and an E2E flow covering capture, identification, retry, and success paths, adhering to coverage goals. [Source: architecture/testing-strategy.md]

## Project Structure Notes

- Place camera UI under `app/identify/` per routing plan; services in `src/lib/services/`; Convex functions in `convex/functions/`. [Source: architecture/unified-project-structure.md]

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |

## Dev Agent Record

### Agent Model Used

- GPT-5 (Codex CLI)

### Debug Log References

- `pnpm test:frontend identify-page.test.tsx`
- `pnpm test:backend identify-functions.test.ts`
- `pnpm test:e2e identify.spec.ts --list` _(fails: local Node 16, Playwright requires ≥18)_

### Completion Notes List

- Implemented `CameraIdentificationPanel` with live capture, retake workflow, offline handling, progress indicator, and comparison history under `src/components/identify`.
- Added `PartIdentificationService` client wrapper plus `identify` Convex action/mutation pair with rate limiting, Brickognize integration, and secure upload lifecycle cleanup.
- Extended Convex HTTP client to support `FormData` payloads for multipart uploads and generated API typings via `pnpm convex codegen`.
- Created focused Jest/Vitest coverage for capture flow and backend safeguards, and expanded Playwright spec stubbing Convex endpoints for high- and low-confidence scenarios.

### File List

- src/app/(authenticated)/identify/page.tsx
- src/components/identify/camera-identification-panel.tsx
- src/lib/services/part-identification-service.ts
- convex/functions/identify.ts
- convex/lib/external/httpClient.ts
- **tests**/frontend/app/identify-page.test.tsx
- **tests**/backend/identify-functions.test.ts
- **tests**/e2e/identify.spec.ts
- convex/\_generated/api.d.ts

## QA Results
