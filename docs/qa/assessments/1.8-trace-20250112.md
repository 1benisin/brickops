# Requirements Traceability Matrix

## Story: 1.8 - User Management and Role-Based Access Control

### Coverage Summary

- Total Requirements: 9
- Fully Covered: 6 (67%)
- Partially Covered: 2 (22%)
- Not Covered: 1 (11%)

### Requirement Mappings

#### AC1.8.1: Account owner can invite new users via email with automatic account setup links

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `__tests__/backend/users-rbac.test.ts::createUserInvite`

  - Given: Owner user with valid business account
  - When: Creating invite with valid email and role
  - Then: Invite token generated and email dispatched

- **Integration Test**: `convex/functions/users.ts::createUserInvite`
  - Given: Owner with rate limit allowance
  - When: Invite creation mutation called
  - Then: Audit log created and email action scheduled

#### AC1.8.2: Account owner can assign roles to users

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `__tests__/backend/users-rbac.test.ts::updateUserRole`

  - Given: Owner user and target member
  - When: Role update mutation called
  - Then: User role updated and audit log created

- **Unit Test**: `__tests__/backend/users-rbac.test.ts::prevents non-owners from updating roles`
  - Given: Non-owner user attempting role update
  - When: Role update mutation called
  - Then: ConvexError thrown with authorization message

#### AC1.8.3: Account owner can view list of all users in their account with current roles

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `convex/functions/users.ts::listMembers`

  - Given: Authenticated user with business account
  - When: List members query called
  - Then: All users in business account returned with roles

- **Frontend Test**: `__tests__/frontend/app/settings-users-page.test.tsx::lists members and hides actions for non-owners`
  - Given: Manager user viewing users page
  - When: Page renders with user list
  - Then: Members displayed with roles, invite button hidden

#### AC1.8.4: Account owner can modify user roles and permissions at any time

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `__tests__/backend/users-rbac.test.ts::allows owners to update other members' roles`

  - Given: Owner user and target member
  - When: Role modification mutation called
  - Then: Role updated successfully with audit trail

- **Frontend Test**: `src/app/(authenticated)/settings/users/page.tsx::handleRoleChange`
  - Given: Owner viewing users page
  - When: Role dropdown changed
  - Then: Role update mutation called and UI updated

#### AC1.8.5: Account owner can remove users from their account with confirmation

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `__tests__/backend/users-rbac.test.ts::allows owners to remove other users but not themselves`

  - Given: Owner user and target member
  - When: Remove user mutation called
  - Then: User soft-deleted and audit log created

- **Frontend Test**: `src/app/(authenticated)/settings/users/page.tsx::handleRemove`
  - Given: Owner viewing users page
  - When: Remove button clicked with confirmation
  - Then: Remove mutation called and user removed from list

#### AC1.8.6: Users receive appropriate access based on their assigned roles across all features

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **Unit Test**: `convex/functions/users.ts::requireActiveUser`

  - Given: User with specific role
  - When: Protected function called
  - Then: Authorization check performed based on role

- **Frontend Test**: `src/app/(authenticated)/settings/users/page.tsx::isOwner check`
  - Given: User with manager role
  - When: Users page rendered
  - Then: Owner-only controls hidden

**Gap**: Missing comprehensive role-based UI gating tests across all features

#### AC1.8.7: System tracks user activity and maintains audit trail of user management changes

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `convex/functions/users.ts::userAuditLogs insertion`

  - Given: User management action performed
  - When: Action completed
  - Then: Audit log entry created with actor, target, and action details

- **Integration Test**: Audit logging in all user management mutations
  - Given: Any user management operation
  - When: Operation executed
  - Then: Audit trail maintained with complete context

#### AC1.8.8: Invited users can complete account setup using secure invitation links

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **Integration Test**: `src/app/(auth)/invite/page.tsx::InviteRedirectPage`

  - Given: User with valid invite token
  - When: Invite page accessed
  - Then: Redirected to signup with token parameter

- **Integration Test**: `src/app/(auth)/signup/page.tsx::invite token handling`
  - Given: User with invite token in URL
  - When: Signup form submitted
  - Then: Account created with assigned role

**Gap**: Missing end-to-end test for complete invite → accept → role enforcement flow

#### AC1.8.9: Users can see their current role and permissions in their profile settings

**Coverage: NONE**

**Gap**: No test coverage found for role display in profile settings

**Suggested Test**:

- **Frontend Test**: Role permissions display component
  - Given: User with specific role
  - When: Profile settings page rendered
  - Then: Current role and permissions displayed correctly

### Critical Gaps

1. **End-to-End Invite Flow** (AC1.8.8)

   - Gap: No complete test from invite creation to role enforcement
   - Risk: High - Critical user journey not validated
   - Action: Implement integration test covering invite → accept → role enforcement

2. **Role Display in Profile** (AC1.8.9)

   - Gap: No test for role permissions display
   - Risk: Medium - User experience not validated
   - Action: Add frontend test for role display component

3. **Comprehensive Role-Based UI Gating** (AC1.8.6)
   - Gap: Limited testing of role-based access across all UI features
   - Risk: Medium - Authorization gaps possible
   - Action: Add comprehensive UI gating tests

### Test Design Recommendations

Based on gaps identified, recommend:

1. **Additional Integration Tests**:

   - Complete invite acceptance flow
   - Role-based UI gating across all features
   - Cross-tenant access prevention

2. **Additional Frontend Tests**:

   - Role display in profile settings
   - Comprehensive UI gating by role
   - Error handling for authorization failures

3. **Additional End-to-End Tests**:
   - Complete user management workflow
   - Invite → accept → role enforcement flow
   - Multi-user role management scenarios

### Risk Assessment

- **High Risk**: Requirements with no coverage (AC1.8.9)
- **Medium Risk**: Requirements with only partial coverage (AC1.8.6, AC1.8.8)
- **Low Risk**: Requirements with full unit + integration coverage (AC1.8.1-1.8.5, AC1.8.7)

### Traceability Quality Indicators

**Good Coverage**:

- Every AC has at least one test
- Critical paths have multiple test levels
- Authorization logic thoroughly tested

**Areas for Improvement**:

- End-to-end user journey coverage
- UI component testing completeness
- Cross-feature integration validation

### Recommendations

1. **Immediate**: Add test for role display in profile settings
2. **Short-term**: Implement end-to-end invite flow test
3. **Long-term**: Add comprehensive role-based UI gating tests

### Test Coverage Summary

| AC    | Description       | Unit | Integration | E2E | Coverage |
| ----- | ----------------- | ---- | ----------- | --- | -------- |
| 1.8.1 | Invite users      | ✓    | ✓           | ✓   | Full     |
| 1.8.2 | Assign roles      | ✓    | ✓           | -   | Full     |
| 1.8.3 | View users        | ✓    | ✓           | -   | Full     |
| 1.8.4 | Modify roles      | ✓    | ✓           | -   | Full     |
| 1.8.5 | Remove users      | ✓    | ✓           | -   | Full     |
| 1.8.6 | Role-based access | ✓    | ⚠️          | -   | Partial  |
| 1.8.7 | Audit trail       | ✓    | ✓           | -   | Full     |
| 1.8.8 | Invite acceptance | -    | ⚠️          | -   | Partial  |
| 1.8.9 | Role display      | -    | -           | -   | None     |

**Legend**: ✓ = Covered, ⚠️ = Partial, - = Not Covered
