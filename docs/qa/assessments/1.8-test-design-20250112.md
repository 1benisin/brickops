# Test Design: Story 1.8

Date: 2025-01-12
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 15
- Unit tests: 8 (53%)
- Integration tests: 5 (33%)
- E2E tests: 2 (13%)
- Priority distribution: P0: 8, P1: 5, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1.8.1: Account owner can invite new users via email with automatic account setup links

#### Scenarios

| ID           | Level       | Priority | Test                                             | Justification         |
| ------------ | ----------- | -------- | ------------------------------------------------ | --------------------- |
| 1.8-UNIT-001 | Unit        | P0       | Validate email format and rate limiting          | Pure validation logic |
| 1.8-INT-001  | Integration | P0       | Invite creation and email dispatch               | Multi-component flow  |
| 1.8-E2E-001  | E2E         | P1       | Complete invite flow from creation to acceptance | Critical user journey |

### AC1.8.2: Account owner can assign roles to users

#### Scenarios

| ID           | Level       | Priority | Test                                     | Justification             |
| ------------ | ----------- | -------- | ---------------------------------------- | ------------------------- |
| 1.8-UNIT-002 | Unit        | P0       | Role assignment authorization checks     | Business logic validation |
| 1.8-INT-002  | Integration | P0       | Role update with audit logging           | Database operations       |
| 1.8-E2E-002  | E2E         | P1       | Owner assigns role and user sees changes | End-to-end validation     |

### AC1.8.3: Account owner can view list of all users in their account with current roles

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification     |
| ------------ | ----------- | -------- | ------------------------------------- | ----------------- |
| 1.8-UNIT-003 | Unit        | P1       | User list query with tenant isolation | Data access logic |
| 1.8-INT-003  | Integration | P1       | List members with role display        | UI data binding   |

### AC1.8.4: Account owner can modify user roles and permissions at any time

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification           |
| ------------ | ----------- | -------- | ------------------------------------- | ----------------------- |
| 1.8-UNIT-004 | Unit        | P0       | Role modification authorization       | Security-critical logic |
| 1.8-INT-004  | Integration | P0       | Role update with real-time UI updates | State management        |

### AC1.8.5: Account owner can remove users from their account with confirmation

#### Scenarios

| ID           | Level       | Priority | Test                                       | Justification       |
| ------------ | ----------- | -------- | ------------------------------------------ | ------------------- |
| 1.8-UNIT-005 | Unit        | P0       | User removal authorization and soft delete | Business logic      |
| 1.8-INT-005  | Integration | P1       | Remove user with audit trail               | Database operations |

### AC1.8.6: Users receive appropriate access based on their assigned roles across all features

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification         |
| ------------ | ----------- | -------- | ------------------------------------- | --------------------- |
| 1.8-UNIT-006 | Unit        | P0       | Role-based access control enforcement | Security-critical     |
| 1.8-INT-006  | Integration | P0       | UI gating based on user role          | Component integration |

### AC1.8.7: System tracks user activity and maintains audit trail of user management changes

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification       |
| ------------ | ----------- | -------- | ------------------------------------- | ------------------- |
| 1.8-UNIT-007 | Unit        | P1       | Audit log creation for user actions   | Data integrity      |
| 1.8-INT-007  | Integration | P1       | Audit trail persistence and retrieval | Database operations |

### AC1.8.8: Invited users can complete account setup using secure invitation links

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification      |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------ |
| 1.8-UNIT-008 | Unit        | P0       | Invite token validation and redemption  | Security-critical  |
| 1.8-INT-008  | Integration | P0       | Account setup flow with role assignment | Multi-step process |

### AC1.8.9: Users can see their current role and permissions in their profile settings

#### Scenarios

| ID           | Level       | Priority | Test                             | Justification      |
| ------------ | ----------- | -------- | -------------------------------- | ------------------ |
| 1.8-UNIT-009 | Unit        | P2       | Role display component rendering | UI component logic |
| 1.8-INT-009  | Integration | P2       | Profile settings role display    | UI integration     |

## Risk Coverage

### Security Risks

- **SEC-001**: Unauthorized role escalation → Covered by 1.8-UNIT-002, 1.8-UNIT-004, 1.8-UNIT-006
- **SEC-002**: Invite token abuse → Covered by 1.8-UNIT-001, 1.8-UNIT-008
- **SEC-003**: Cross-tenant data access → Covered by 1.8-UNIT-003, 1.8-UNIT-006

### Business Risks

- **BUS-001**: User management errors → Covered by 1.8-INT-002, 1.8-INT-004, 1.8-INT-005
- **BUS-002**: Audit trail gaps → Covered by 1.8-UNIT-007, 1.8-INT-007

## Recommended Execution Order

1. **P0 Unit tests** (fail fast)

   - 1.8-UNIT-001: Email validation and rate limiting
   - 1.8-UNIT-002: Role assignment authorization
   - 1.8-UNIT-004: Role modification authorization
   - 1.8-UNIT-005: User removal authorization
   - 1.8-UNIT-006: RBAC enforcement
   - 1.8-UNIT-008: Invite token validation

2. **P0 Integration tests**

   - 1.8-INT-001: Invite creation and email dispatch
   - 1.8-INT-002: Role update with audit logging
   - 1.8-INT-004: Role update with real-time UI updates
   - 1.8-INT-006: UI gating based on user role
   - 1.8-INT-008: Account setup flow

3. **P0 E2E tests**

   - 1.8-E2E-001: Complete invite flow
   - 1.8-E2E-002: Role assignment end-to-end

4. **P1 tests** (as time permits)

   - 1.8-UNIT-003: User list query
   - 1.8-INT-003: List members with role display
   - 1.8-INT-005: Remove user with audit trail
   - 1.8-UNIT-007: Audit log creation
   - 1.8-INT-007: Audit trail persistence

5. **P2 tests** (nice to have)
   - 1.8-UNIT-009: Role display component
   - 1.8-INT-009: Profile settings role display

## Coverage Gaps Identified

1. **Missing E2E test for user removal flow** - Should test complete removal process with confirmation
2. **Missing integration test for audit log retrieval** - Should test querying audit logs
3. **Missing unit test for invite expiration handling** - Should test expired invite scenarios
4. **Missing integration test for concurrent role updates** - Should test race conditions

## Test Data Requirements

- Test business accounts with multiple users
- Test users with different roles (owner, manager, picker, viewer)
- Test invite tokens with various expiration states
- Test audit log entries for different actions
- Test rate limiting scenarios with multiple invite attempts

## Test Environment Setup

- Isolated test database with seed data
- Mock email service for invite testing
- Test user accounts with different roles
- Rate limiting test scenarios
- Audit log verification utilities
