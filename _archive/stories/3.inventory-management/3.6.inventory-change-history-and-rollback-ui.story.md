# Story 3.6: Inventory Change History and Rollback UI

## Status

Draft

## Story

**As a** user,
**I want** to view my complete inventory change history and rollback changes when needed,
**so that** I can track all inventory modifications, correct mistakes, and maintain full accountability over my inventory operations.

## Acceptance Criteria

1. **3.6.1:** Provide a dedicated "Inventory Change History" UI accessible from the inventory management section showing all `inventorySyncQueue` entries for the user's business account with most recent changes displayed first (paginated).
2. **3.6.2:** Display comprehensive change details per entry: timestamp, actor (user who made the change), change type (create/update/delete), item identifier, data snapshots (previousData, newData), reason/notes, and sync status per provider (BrickLink, BrickOwl).
3. **3.6.3:** Implement append-only sync queue: every change creates an immutable queue entry, and undo operations create new compensating entries that reference the original change (never delete or modify existing entries).
4. **3.6.4:** Support undo functionality with explicit tracking: when a user undoes a change, create a new queue entry marked as `isUndo: true` with `undoesChangeId` referencing the original change, and update the original entry with `undoneByChangeId` to mark it as undone.
5. **3.6.5:** Allow users to undo an undo (effectively a redo): treating undo-of-undo as another compensating action with proper reference chain tracking in the audit log.
6. **3.6.6:** Provide visual indicators in the UI: show "[UNDONE]" badge on entries that have been reversed, "[UNDO]" badge on undo operations, and display the reference chain (e.g., "Undid change #123").
7. **3.6.7:** Implement "Undo" action buttons per change entry (where applicable) that prompt for a reason, execute the compensating operation on `inventoryItems` and create compensating sync queue entry with marketplace sync, atomically.
8. **3.6.8:** Prevent duplicate undos: disable undo button and show status if a change has already been undone (check `undoneByChangeId` field).
9. **3.6.9:** Enforce RBAC on undo operations: only owner role can perform rollbacks; audit who initiated each undo.
10. **3.6.10:** Provide filtering and search capabilities: filter by date range, change type, actor, item, or undo status; search by item identifier or reason text.
11. **3.6.11:** Show multi-provider sync status per change: display sync status independently for BrickLink and BrickOwl (pending, syncing, synced, failed); surface per-provider sync errors with timestamps and actionable messages.
12. **3.6.12:** Ensure complete audit trail for compliance: all undo operations are logged with who performed the undo, when, and why; no logs are ever deleted or modified.

## Tasks / Subtasks

- [ ] Task 1: Create inventory change history backend queries (AC: 3.6.1, 3.6.2, 3.6.10, 3.6.11)

  - [ ] Add query `inventory.getChangeHistory(businessAccountId, options?)` in `convex/inventory/queries.ts` returning paginated `inventorySyncQueue` entries ordered by `createdAt` DESC
  - [ ] Add query `inventory.getChangeDetails(changeId)` returning full change details including `previousData`, `newData`, sync status per provider, and undo chain references
  - [ ] Add query `inventory.searchChangeHistory(businessAccountId, searchParams)` supporting filtering by date range, change type, actor, item identifier, undo status
  - [ ] Include user details (firstName, lastName) in change history queries by joining with `users` table via `createdBy` field
  - [ ] Add query `inventory.getChangeStats(businessAccountId)` returning summary counts: total changes, pending syncs, failed syncs, undone changes
  - [ ] [Source: docs/architecture/backend-architecture.md#queries; docs/architecture/database-schema.md#inventorySyncQueue]

- [ ] Task 2: Implement undo functionality backend (AC: 3.6.4, 3.6.5, 3.6.7, 3.6.8, 3.6.9)

  - [ ] Add mutation `inventory.undoChange(changeId, reason)` in `convex/inventory/mutations.ts` with owner RBAC enforcement
  - [ ] Validate change can be undone: check `undoneByChangeId` is null, verify item still exists for applicable change types
  - [ ] Execute compensating operation on `inventoryItems` table: CREATE→DELETE, UPDATE→UPDATE with previous values, DELETE→CREATE with previous data
  - [ ] Create new `inventorySyncQueue` entry marked as undo: set `isUndo: true`, `undoesChangeId: changeId`, include user-provided reason
  - [ ] Update original change entry: set `undoneByChangeId` to reference the new undo entry (bidirectional link)
  - [ ] Enqueue marketplace sync for compensating operation using existing sync orchestration from Story 3.4
  - [ ] Support "undo of undo" (redo): treat as another compensating operation with proper reference chain tracking
  - [ ] All operations must be atomic: inventory change + undo log entry + original log update in single transaction
  - [ ] [Source: docs/stories/3.4.convex-orchestration-layer.story.md#task-6; docs/architecture/backend-architecture.md#mutations]

- [ ] Task 3: Create inventory change history UI page (AC: 3.6.1, 3.6.2, 3.6.6)

  - [ ] Create `src/app/(authenticated)/inventory/history/page.tsx` with owner role protection
  - [ ] Implement paginated table showing change history with columns: timestamp, actor, change type, item identifier, sync status, actions
  - [ ] Add visual indicators: "[UNDONE]" badge for reversed entries, "[UNDO]" badge for undo operations
  - [ ] Display reference chain: "Undid change #123" for undo operations
  - [ ] Show comprehensive change details in expandable rows or modal: previous/new data snapshots, reason, sync status per provider
  - [ ] Use shadcn/ui DataTable component with sorting, pagination, and row expansion
  - [ ] Add navigation link from inventory management section to change history page
  - [ ] [Source: docs/architecture/frontend-architecture.md#component-architecture; docs/architecture/unified-project-structure.md]

- [ ] Task 4: Implement undo action UI components (AC: 3.6.7, 3.6.8, 3.6.9)

  - [ ] Create `src/components/inventory/UndoChangeDialog.tsx` with reason input field and confirmation
  - [ ] Add "Undo" action button per change entry with conditional rendering: only show if change can be undone
  - [ ] Disable undo button and show status if change has already been undone (check `undoneByChangeId` field)
  - [ ] Implement optimistic UI updates: show undo in progress state, then update with actual result
  - [ ] Add confirmation dialog: "Are you sure you want to undo this change? This will reverse the inventory modification and sync to marketplaces."
  - [ ] Require reason input: "Please provide a reason for undoing this change (required for audit trail)"
  - [ ] Use shadcn/ui Dialog, Button, Input, and AlertDialog components
  - [ ] [Source: docs/architecture/frontend-architecture.md#shadcn-ui-component-installation; docs/architecture/testing-strategy.md#frontend-component-test]

- [ ] Task 5: Implement filtering and search functionality (AC: 3.6.10)

  - [ ] Add filter controls: date range picker, change type dropdown (create/update/delete), actor dropdown, undo status toggle
  - [ ] Implement search by item identifier (part number, SKU) and reason text using backend search query
  - [ ] Add clear filters functionality and filter state persistence in URL parameters
  - [ ] Use shadcn/ui Select, DatePicker, Input, and Badge components for filter UI
  - [ ] Implement client-side filtering for quick responses and server-side filtering for complex queries
  - [ ] Add filter summary display: "Showing 25 of 150 changes (filtered by: Last 7 days, Create operations)"
  - [ ] [Source: docs/architecture/frontend-architecture.md#state-management-architecture; docs/architecture/unified-project-structure.md]

- [ ] Task 6: Implement multi-provider sync status display (AC: 3.6.11)

  - [ ] Create `src/components/inventory/SyncStatusIndicator.tsx` showing sync status per provider (BrickLink, BrickOwl)
  - [ ] Display sync status with icons and colors: pending (clock), syncing (spinner), synced (check), failed (x)
  - [ ] Show sync timestamps and error details in tooltip or expandable section
  - [ ] Add retry functionality for failed syncs (if supported by backend)
  - [ ] Use shadcn/ui Badge, Tooltip, and Progress components for status display
  - [ ] Implement real-time updates using Convex subscriptions to sync status changes
  - [ ] [Source: docs/architecture/frontend-architecture.md#state-management-architecture; docs/stories/3.4.convex-orchestration-layer.story.md#task-5]

- [ ] Task 7: Add comprehensive testing (AC: 3.6.12)

  - [ ] Create `__tests__/backend/inventory-change-history.test.ts` testing undo functionality, RBAC enforcement, and atomic operations
  - [ ] Create `__tests__/frontend/inventory/ChangeHistoryPage.test.tsx` testing UI components, filtering, and undo actions
  - [ ] Create `__tests__/frontend/inventory/UndoChangeDialog.test.tsx` testing dialog interactions and validation
  - [ ] Add E2E test `e2e/inventory/change-history-and-undo.spec.ts` testing complete undo workflow
  - [ ] Test undo chain scenarios: undo → undo of undo (redo) → verify reference chain integrity
  - [ ] Test RBAC: verify only owner role can perform undo operations
  - [ ] Test audit trail: verify all undo operations are logged with user, timestamp, and reason
  - [ ] [Source: docs/architecture/testing-strategy.md#testing-pyramid; docs/architecture/testing-strategy.md#frontend-component-test]

- [ ] Task 8: Add navigation and integration (AC: 3.6.1)

  - [ ] Add "Change History" link in inventory management navigation menu
  - [ ] Add change history quick access from inventory item detail pages
  - [ ] Implement breadcrumb navigation: Inventory → Change History
  - [ ] Add change history link in inventory dashboard with recent changes summary
  - [ ] Update inventory page to show recent changes count and link to full history
  - [ ] [Source: docs/architecture/frontend-architecture.md#routing-architecture; docs/architecture/unified-project-structure.md]

## Dev Notes

### Previous Story Insights

- Story 3.4 implemented the `inventorySyncQueue` table and undo functionality backend
- Story 3.5 added inventory files with batch sync capabilities
- The sync queue already supports undo tracking with `isUndo`, `undoesChangeId`, and `undoneByChangeId` fields
- Marketplace sync orchestration is already implemented and working

### Data Models

- **inventorySyncQueue**: Contains all change history with undo chain references [Source: docs/architecture/database-schema.md#inventorySyncQueue]
- **inventoryItems**: Core inventory data that gets modified by undo operations [Source: docs/architecture/database-schema.md#inventoryItems]
- **users**: User details for displaying actor information in change history [Source: docs/architecture/data-models.md#user]

### API Specifications

- **Backend Queries**: Use Convex queries for real-time reactive data fetching [Source: docs/architecture/backend-architecture.md#queries]
- **Backend Mutations**: Use Convex mutations for undo operations with atomic transactions [Source: docs/architecture/backend-architecture.md#mutations]
- **RBAC Enforcement**: Owner role required for undo operations [Source: docs/architecture/backend-architecture.md#authentication-and-authorization]

### Component Specifications

- **shadcn/ui Components**: Use DataTable, Dialog, Button, Input, Badge, Tooltip, Progress components [Source: docs/architecture/frontend-architecture.md#shadcn-ui-component-installation]
- **State Management**: Use React built-in state for UI state, Convex subscriptions for server state [Source: docs/architecture/frontend-architecture.md#state-management-architecture]
- **Routing**: Use Next.js App Router with protected routes [Source: docs/architecture/frontend-architecture.md#routing-architecture]

### File Locations

- **Backend**: `convex/inventory/queries.ts`, `convex/inventory/mutations.ts` [Source: docs/architecture/unified-project-structure.md]
- **Frontend**: `src/app/(authenticated)/inventory/history/page.tsx`, `src/components/inventory/` [Source: docs/architecture/unified-project-structure.md]
- **Tests**: `__tests__/backend/`, `__tests__/frontend/inventory/`, `e2e/inventory/` [Source: docs/architecture/unified-project-structure.md]

### Testing Requirements

- **Frontend Tests**: Jest + RTL with `act()` for state updates, `waitFor()` for async assertions [Source: docs/architecture/testing-strategy.md#frontend-component-test]
- **Backend Tests**: Vitest with Convex test utilities [Source: docs/architecture/testing-strategy.md#backend-function-test]
- **E2E Tests**: Playwright with proper authentication mocking [Source: docs/architecture/testing-strategy.md#e2e-test]
- **Test IDs**: All interactive elements must have `data-testid` attributes [Source: docs/architecture/testing-strategy.md#test-id-guidelines]

### Technical Constraints

- **Atomic Operations**: All undo operations must be atomic (inventory change + undo log + original log update) [Source: docs/architecture/backend-architecture.md#mutations]
- **Real-time Updates**: Use Convex subscriptions for reactive UI updates [Source: docs/architecture/frontend-architecture.md#state-management-architecture]
- **RBAC**: Only owner role can perform undo operations [Source: docs/architecture/backend-architecture.md#authentication-and-authorization]
- **Audit Trail**: Complete audit trail required for compliance - no logs deleted or modified [Source: docs/prd/epic-3-inventory-management.md#story-36]

## Testing

### Testing Standards

- **Test File Location**: `__tests__/backend/` for Convex functions, `__tests__/frontend/inventory/` for React components, `e2e/inventory/` for E2E tests [Source: docs/architecture/testing-strategy.md#test-organization]
- **Testing Frameworks**: Jest + RTL for frontend, Vitest for backend, Playwright for E2E [Source: docs/architecture/testing-strategy.md#testing-pyramid]
- **Test Patterns**: Use `act()` for React state updates, `waitFor()` for async assertions, proper authentication mocking [Source: docs/architecture/testing-strategy.md#react-testing-best-practices]
- **Test IDs**: All interactive elements must have `data-testid` attributes following naming convention [Source: docs/architecture/testing-strategy.md#test-id-guidelines]

### Specific Testing Requirements

- **Undo Functionality**: Test atomic operations, RBAC enforcement, undo chain integrity
- **UI Components**: Test filtering, search, undo dialog interactions, optimistic updates
- **E2E Workflow**: Test complete undo workflow from UI to marketplace sync
- **Audit Trail**: Verify all operations are logged with proper user, timestamp, and reason

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-12 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
