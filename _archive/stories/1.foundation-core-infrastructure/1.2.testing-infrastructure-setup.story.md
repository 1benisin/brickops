# Story 1.2: Testing Infrastructure Setup

## Status

Done

## Story

**As a** development team,
**I want** comprehensive testing infrastructure configured,
**so that** we can write reliable tests from the start of development.

This work completes the Epic 1 foundation by delivering the automated verification layer that keeps the new platform stable as future stories land.

## Acceptance Criteria

1. **1.2.1:** Install and configure Jest with React Testing Library for frontend unit tests
2. **1.2.2:** Install and configure Vitest for Convex backend function testing
3. **1.2.3:** Install and configure Playwright for end-to-end testing including camera flows
4. **1.2.4:** Set up test database configuration for isolated test runs
5. **1.2.5:** Create test utilities and mocks for external APIs (Brickognize, Bricklink, Brickowl)
6. **1.2.6:** Configure test coverage reporting with appropriate thresholds
7. **1.2.7:** Set up continuous integration test running in development pipeline
8. **1.2.8:** Create example test files demonstrating testing patterns
9. **1.2.9:** Verify all testing frameworks work together without conflicts

### Dependencies

- Story 1.1 (`docs/stories/1.1.component-system-foundation-shadcn-ui.story.md`) must be completed so the hardened navigation mocks and shadcn/ui components are available for the example tests referenced in this story.

## Tasks / Subtasks

- [x] Task 1 (AC: 1.2.1, 1.2.8) — Configure Jest + React Testing Library with enhanced frontend testing capabilities. [Source: architecture/tech-stack.md#tech-stack; architecture/testing-strategy.md#frontend-tests]

  - [x] Install Jest, React Testing Library, and @testing-library/jest-dom as dev dependencies with TypeScript support
  - [x] Configure jest.config.cjs to recognize Next.js app structure, TypeScript paths, and Convex client mocks [Source: architecture/testing-strategy.md#test-examples]
  - [x] Set up jest.setup.ts with RTL globals and ConvexProvider test utilities [Source: architecture/testing-strategy.md#frontend-component-test]
  - [x] Create example component tests following the InventoryCard pattern with ConvexProvider wrapping [Source: architecture/testing-strategy.md#frontend-component-test]
  - [x] Ensure tests can handle Next.js routing hooks (usePathname) and prevent null reference issues discovered in Story 1.1

- [x] Task 2 (AC: 1.2.2, 1.2.8) — Install and configure Vitest for Convex backend function testing. [Source: architecture/tech-stack.md#tech-stack; architecture/testing-strategy.md#backend-tests]

  - [x] Install Vitest 1.2.0+ with TypeScript and convex-test utilities as dev dependencies [Source: architecture/tech-stack.md#tech-stack]
  - [x] Configure vitest.config.ts for Convex function testing with proper module resolution [Source: architecture/testing-strategy.md#backend-tests]
  - [x] Set up test database isolation for Convex function testing [Source: architecture/testing-strategy.md#backend-function-test]
  - [x] Create example backend function tests following the addInventoryItem pattern with schema validation [Source: architecture/testing-strategy.md#backend-function-test]

- [x] Task 3 (AC: 1.2.3, 1.2.8) — Install and configure Playwright for end-to-end testing with camera workflow support. [Source: architecture/tech-stack.md#tech-stack; architecture/testing-strategy.md#e2e-tests]

  - [x] Install Playwright 1.40.0+ with browsers and configure playwright.config.ts [Source: architecture/tech-stack.md#tech-stack]
  - [x] Configure test projects for different browsers and mobile viewports [Source: architecture/testing-strategy.md#e2e-tests]
  - [x] Set up camera access mocking for identification workflows [Source: architecture/testing-strategy.md#e2e-test]
  - [x] Create example e2e test following camera identification pattern [Source: architecture/testing-strategy.md#e2e-test]

- [x] Task 4 (AC: 1.2.4) — Configure test database isolation and environment setup. [Source: architecture/backend-architecture.md#authentication-and-authorization]

  - [x] Set up separate test environment configuration for Convex with isolated data
  - [x] Configure test utilities for BusinessAccount and User creation with proper tenant isolation [Source: architecture/backend-architecture.md#authentication-and-authorization]
  - [x] Ensure all tests run with proper authentication context and businessAccountId filtering [Source: architecture/backend-architecture.md#function-template]

- [x] Task 5 (AC: 1.2.5) — Create test utilities and API mocks for external services. [Source: architecture/testing-strategy.md#backend-tests]

  - [x] Create mock implementations for Brickognize API integration testing
  - [x] Create mock implementations for Bricklink API integration testing
  - [x] Create mock implementations for Brickowl API integration testing
  - [x] Set up test utilities for API rate limiting and error scenario testing [Source: architecture/coding-standards.md#critical-rules]

- [x] Task 6 (AC: 1.2.6) — Configure comprehensive test coverage reporting. [Source: architecture/testing-strategy.md#testing-pyramid]

  - [x] Set up Jest coverage reporting for frontend with 80% unit test coverage threshold [Source: architecture/testing-strategy.md#testing-pyramid]
  - [x] Configure Vitest coverage reporting for backend functions with 80% coverage threshold [Source: architecture/testing-strategy.md#testing-pyramid]
  - [x] Set up coverage aggregation and reporting across frontend and backend test suites
  - [x] Configure coverage thresholds to enforce 100% critical path coverage for inventory sync and order processing [Source: architecture/testing-strategy.md#testing-pyramid]

- [x] Task 7 (AC: 1.2.7) — Configure CI/CD pipeline integration for automated test running. [Source: architecture/tech-stack.md#tech-stack]

  - [x] Add test scripts to package.json for different test suites (frontend, backend, e2e)
  - [x] Configure pnpm workspace scripts for running tests across the entire project [Source: architecture/unified-project-structure.md#unified-project-structure]
  - [x] Set up test result reporting and failure notifications for development workflow
  - [x] Ensure tests can run in Vercel deployment pipeline context [Source: architecture/tech-stack.md#tech-stack]

- [x] Task 8 (AC: 1.2.8) — Create comprehensive example test files demonstrating all patterns. [Source: architecture/testing-strategy.md#test-examples]

  - [x] Create frontend component test examples showing ConvexProvider integration [Source: architecture/testing-strategy.md#frontend-component-test]
  - [x] Create backend function test examples with proper auth validation and schema testing [Source: architecture/testing-strategy.md#backend-function-test]
  - [x] Create e2e test examples covering authentication flows and camera workflows [Source: architecture/testing-strategy.md#e2e-test]
  - [x] Document testing patterns and best practices in test files for developer reference

- [x] Task 9 (AC: 1.2.9) — Validate testing framework integration and resolve conflicts.
  - [x] Run all test suites simultaneously to ensure no port conflicts or resource contention
  - [x] Verify Jest, Vitest, and Playwright can run in parallel during development
  - [x] Test coverage reporting works correctly across all frameworks
  - [x] Ensure testing infrastructure supports the existing project structure and doesn't break current functionality

## Dev Notes

### Previous Story Insights

- Story 1.1 had testing challenges with usePathname() returning null in Jest, requiring proper mocking of Next.js routing hooks [Source: previous story Dev Agent Record]
- Frontend testing infrastructure is partially established with Jest RTL but needs enhancement and integration with backend testing
- The command `pnpm test:frontend` is already configured and working after navigation hardening fixes [Source: previous story Dev Agent Record]

### Data Models

- BusinessAccount and User models require proper tenant isolation testing with businessAccountId filtering [Source: architecture/data-models.md#businessaccount; architecture/backend-architecture.md#authentication-and-authorization]
- Testing must validate authentication context and role-based access control across all functions [Source: architecture/data-models.md#user; architecture/backend-architecture.md#function-template]
- InventoryItem, MarketplaceOrder, and PickSession models will need test coverage for audit trails and workflow integrity [Source: architecture/data-models.md#legopartcatalog-inventoryitem-marketplaceorder-picksession-todoitem]

### API Specifications

- Brickognize camera identification flows and error handling dictate the mock responses for camera-based tests. [Source: docs/external/apis/brickognize.md#integration-notes; docs/external/apis/brickognize.md#error-responses]
- Bricklink OAuth requirements and order payload structures shape the backend mock utilities. [Source: docs/external/apis/bricklink.md#authentication--authorization; docs/external/apis/bricklink.md#order-resource-representations]
- Brickowl catalog and store inventory endpoints define the request arguments and data permutations the mocks must support. [Source: docs/external/apis/brickowl.md#catalog; docs/external/apis/brickowl.md#store-inventory]

### Component Specifications

- ConvexProvider must wrap all component tests to provide proper client context [Source: architecture/testing-strategy.md#frontend-component-test]
- Test utilities must handle real-time subscriptions and state management patterns used across UI components [Source: architecture/frontend-architecture.md#state-management-architecture]
- Camera-related components will require getUserMedia API mocking for identification workflow testing [Source: architecture/testing-strategy.md#e2e-test]

### File Locations

- Frontend tests: `__tests__/components/`, `__tests__/hooks/`, `__tests__/services/`, `__tests__/utils/` [Source: architecture/testing-strategy.md#frontend-tests]
- Backend tests: `convex/functions/*.test.ts`, `convex/__tests__/integration/`, `convex/__tests__/api/` [Source: architecture/testing-strategy.md#backend-tests]
- E2E tests: `e2e/auth/`, `e2e/inventory/`, `e2e/orders/`, `e2e/picking/` [Source: architecture/testing-strategy.md#e2e-tests]
- Test configuration files in project root: `jest.config.cjs`, `vitest.config.ts`, `playwright.config.ts` [Source: architecture/unified-project-structure.md#unified-project-structure]

### Testing Requirements

- 80% unit test coverage for both frontend and backend [Source: architecture/testing-strategy.md#testing-pyramid]
- 60% integration test coverage [Source: architecture/testing-strategy.md#testing-pyramid]
- 100% coverage for critical paths (inventory sync, order processing, picking workflows) [Source: architecture/testing-strategy.md#testing-pyramid]
- Test organization follows domain-based structure matching component architecture [Source: architecture/testing-strategy.md#test-organization]

### Technical Constraints

- Jest Latest + RTL Latest for frontend unit/integration tests [Source: architecture/tech-stack.md#tech-stack]
- Vitest 1.2.0+ for backend function testing with TS-native support [Source: architecture/tech-stack.md#tech-stack]
- Playwright 1.40.0+ for cross-browser E2E testing with camera flows [Source: architecture/tech-stack.md#tech-stack]
- pnpm 8.15.0+ workspace compatibility for test script organization [Source: architecture/tech-stack.md#tech-stack]
- Node.js 20.11.0 LTS compatibility for all testing dependencies [Source: architecture/tech-stack.md#tech-stack]

### Project Structure Notes

- Testing infrastructure must integrate with existing pnpm workspace configuration [Source: architecture/unified-project-structure.md#unified-project-structure]
- Test files should follow domain-based organization matching the component and function structure [Source: architecture/testing-strategy.md#test-organization]

## Testing

- Validate Jest + RTL configuration with existing component structure in `src/components/`
- Test Vitest configuration with Convex functions in `convex/functions/`
- Verify Playwright setup with Next.js App Router and camera access patterns
- Ensure all test frameworks can run concurrently without conflicts

## Change Log

| Date       | Version | Description                 | Author             |
| ---------- | ------- | --------------------------- | ------------------ |
| 2025-09-21 | 0.1     | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Codex GPT-5

### Debug Log References

- pnpm test:frontend
- pnpm test:backend
- pnpm test:e2e:dry-run
- pnpm test:coverage

### Completion Notes List

- Established unified Jest configuration with navigation mocks, provider-aware render helper, and InventoryCard sample suite.
- Added Convex inventory functions plus isolated test harness for backend mutations/queries with Vitest coverage thresholds.
- Upgraded Playwright config for multi-device runs, introduced camera mocking utility, and authored identification workflow example spec.
- Created reusable Brickognize/Bricklink/Brickowl mocks for unit and E2E scenarios alongside new CI-friendly test scripts and coverage aggregation.
- Installed `@vitest/coverage-v8` and aligned Vitest to 3.2.4; backend coverage now runs under v8 provider.
- Corrected coverage thresholds to enforce documented percentages and ignored `test-results/` artifacts; reran `pnpm test:frontend` and `pnpm test:backend` to confirm.

### File List

- jest.config.cjs
- jest.setup.ts
- package.json
- README.md
- tsconfig.json
- vitest.config.ts
- playwright.config.ts
- convex/schema.ts
- convex/\_generated/server.ts
- convex/functions/inventory.ts
- src/components/inventory/inventory-card.tsx
- src/components/inventory/index.ts
- **tests**/frontend/components/inventory/inventory-card.test.tsx
- **tests**/backend/inventory-functions.test.ts
- **tests**/e2e/identify.spec.ts
- test/mocks/next-navigation.ts
- test/mocks/apis/brick-integrations.ts
- test/utils/render-with-providers.tsx
- test/utils/next-navigation.ts
- test/utils/convex-test-context.ts
- test/utils/playwright/camera.ts
- test/utils/brick-integrations.ts

## QA Results

_Pending QA review_

### Review Date: 2025-09-21

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Solid foundation for frontend, backend, and E2E harnesses; sample suites run cleanly across tooling.
- Coverage enforcement misconfigured (`coverageThreshold` and `thresholds` use decimals instead of percentages), so AC 1.2.6 is not actually satisfied.
- Story remains in `Ready` instead of `Review`, which may confuse downstream workflow.

### Refactoring Performed

- None; review was read-only.

### Compliance Check

- Coding Standards: ✓ — Files follow documented patterns and lint/test scripts pass locally.
- Project Structure: ✓ — New utilities live under `test/` with clear module aliases.
- Testing Strategy: ✗ — Coverage thresholds set below documented targets due to decimal usage.
- All ACs Met: ✗ — AC 1.2.6 uncovered configuration gap; see issues below.

### Improvements Checklist

- [ ] Fix coverage thresholds to use whole-number percentages (e.g., `80`, not `0.8`) in `jest.config.cjs` and `vitest.config.ts`.
- [ ] Add `test-results/` artifacts to `.gitignore` (or remove from repo) to avoid committing Playwright failure outputs.
- [ ] Update story status to `Review` before the next QA pass to reflect workflow state.

### Security Review

- No new security risks identified; Convex auth guards are present in sample mutations.

### Performance Considerations

- No blocking performance issues; note that inventory lookups currently scan entire tables and may need index usage as data grows.

### Files Modified During Review

- None.

### Gate Status

Gate: FAIL → qa.qaLocation/gates/1.2-testing-infrastructure-setup.yml
Risk profile: qa.qaLocation/assessments/1.2-risk-20250921.md
NFR assessment: qa.qaLocation/assessments/1.2-nfr-20250921.md

### Recommended Status

[✗ Changes Required - See unchecked items above]

### Review Date: 2025-09-21 (Follow-up)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Coverage thresholds now use integer percentages in Jest and Vitest, aligning with AC 1.2.6 and enforcing the documented quality bar.
- `test-results/` artifacts are ignored and cleaned up, so Playwright diagnostics no longer pollute the repo.
- All sample suites continue to pass after the configuration updates.

### Refactoring Performed

- None; verification-only follow-up.

### Compliance Check

- Coding Standards: ✓ — No new deviations detected.
- Project Structure: ✓ — Added ignore entry keeps repo tidy without structure changes.
- Testing Strategy: ✓ — Coverage gates match documented thresholds and pass locally.
- All ACs Met: ✓ — AC 1.2.6 satisfied after threshold correction.

### Improvements Checklist

- [x] Fix coverage thresholds to use whole-number percentages (e.g., `80`, not `0.8`) in `jest.config.cjs` and `vitest.config.ts`.
- [x] Add `test-results/` artifacts to `.gitignore` (or remove from repo) to avoid committing Playwright failure outputs.
- [ ] Update story status to `Review` before the next QA pass to reflect workflow state.

### Security Review

- No security regressions identified during follow-up.

### Performance Considerations

- No new performance risks; coverage enforcement has negligible runtime impact.

### Files Modified During Review

- None.

### Gate Status

Gate: PASS → qa.qaLocation/gates/1.2-testing-infrastructure-setup.yml
Risk profile: qa.qaLocation/assessments/1.2-risk-20250921.md
NFR assessment: qa.qaLocation/assessments/1.2-nfr-20250921.md

### Recommended Status

[✓ Ready for Done]
